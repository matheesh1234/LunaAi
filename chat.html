<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Luna</title>
    <link rel="icon" type="image/png" href="Icon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=Oo18ogKgR2aFbHhlanb0bp3IZ3iWijAE7bZLCgYfC0C6FeaPbV4baNOcODSGwfz4JpykayQR9Z-hT_7BwScncw" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9sdW5hYWlvZmZpY2lhbC5uZXRsaWZ5LmFwcC9jaGF0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5782374845716287"
     crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            /* Prevent the whole page from scrolling */
            overflow: hidden;
        }
        #sidebar, #historySidebar {
            transition: width 0.3s ease, padding 0.3s ease, transform 0.3s ease;
        }
        #sidebar.hide {
            width: 0;
            overflow: hidden;
            padding: 0 !important;
        }
        #historySidebar {
            transform: translateX(100%);
        }
        #historySidebar.show {
            transform: translateX(0);
        }
        body.history-open #mainContent {
            margin-right: 16rem; /* Adjust based on history sidebar width (w-64) */
        }
        @media (max-width: 768px) {
            body.history-open #mainContent {
                margin-right: 0; 
            }
        }
        .chat-window::-webkit-scrollbar, #historyList::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-thumb, #historyList::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
        }
        .chat-window::-webkit-scrollbar-track, #historyList::-webkit-scrollbar-track {
            background-color: transparent;
        }
        .dark .chat-window::-webkit-scrollbar-thumb, .dark #historyList::-webkit-scrollbar-thumb {
            background-color: #4a5568;
        }
        .spinner {
         border: 4px solid rgba(0, 0, 0, 0.1);
         border-left-color: currentColor;
         border-radius: 50%;
         width: 1.5rem;
         height: 1.5rem;
         animation: spin 1s linear infinite;
        }
        @keyframes spin {
         to { transform: rotate(360deg); }
        }

        /* Typing Indicator Animation */
        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Quick Reply Buttons */
        .quick-reply-btn {
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }
        .quick-reply-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .dark .quick-reply-btn {
            border-color: #4b5563;
        }

        /* Voice Input Animation */
        .voice-btn.recording {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Response Action Buttons */
        .action-btn {
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.3s ease;
        }
        .message-bubble:hover .action-btn {
            opacity: 1;
            transform: translateY(0);
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .unlock-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none;
            align-items: center; justify-content: center; z-index: 100;
        }
        .unlock-modal.show { display: flex; }
        .unlock-modal-content {
            background-color: white; padding: 2rem; border-radius: 1rem;
            width: 90%; max-width: 400px; text-align: center; position: relative;
        }
        .dark .unlock-modal-content { background-color: #1f2937; }
        .unlock-modal .close-btn {
            position: absolute; top: 1rem; right: 1rem;
            color: #9ca3af; cursor: pointer;
        }
        .pro-feature-overlay {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; text-align: center;
        }
        .pro-feature-overlay h2 {
            font-size: 2rem; font-weight: 700; margin-bottom: 1rem;
            background-clip: text; -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(to right, #60a5fa, #34d399);
        }
        .dark .pro-feature-overlay h2 {
            background-image: linear-gradient(to right, #93c5fd, #6ee7b7);
        }
        .pro-feature-overlay p {
            color: #6b7280; margin-bottom: 1.5rem;
        }
        .dark .pro-feature-overlay p { color: #9ca3af; }

        .message-bubble {
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            position: relative;
        }
        .user-bubble {
            white-space: pre-wrap;
        }
        .message-bubble p { margin-bottom: 0.5rem; }
        .message-bubble p:last-child { margin-bottom: 0; }
        .message-bubble ul, .message-bubble ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }
        .message-bubble li { margin-bottom: 0.25rem; }
        .message-bubble strong { font-weight: 600; }
        .message-bubble pre {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.75rem 0;
            font-size: 0.875rem;
        }
        .dark .message-bubble pre { background-color: #111827; }
        .message-bubble code {
            font-family: 'Courier New', Courier, monospace;
            background-color: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .dark .message-bubble code { background-color: rgba(255,255,255,0.1); }
        .message-bubble pre > code {
            background-color: transparent;
            padding: 0;
            font-size: inherit;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

    </style>

    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 font-sans transition-colors duration-300">

    <header class="bg-white dark:bg-gray-800 shadow-md flex items-center justify-between px-6 py-4 fixed w-full z-30 top-0">
        <div class="flex items-center space-x-3">
            <button id="toggleSidebar" class="mr-4 text-gray-600 dark:text-gray-300 focus:outline-none hover:scale-110 transition" aria-label="Toggle Sidebar">
                <i data-feather="menu"></i>
            </button>
            <span class="font-bold text-2xl bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-green-500">LunaAi<sup style="font-size: 12px; color: #666; font-family: Arial;">â„¢</sup></span>
        </div>
        <div class="flex items-center space-x-4">
            <button id="toggleHistory" class="text-gray-600 dark:text-gray-300 hover:scale-110 transition" aria-label="Toggle Chat History">
                <i data-feather="clock"></i>
            </button>
            <button id="toggleDarkMode" class="hover:scale-110 transition text-gray-600 dark:text-gray-300" aria-label="Toggle Dark Mode">
            </button>
            <div class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600 bg-gray-200 dark:bg-gray-700 flex items-center justify-center" aria-label="User Profile">
                <i data-feather="user" class="w-6 h-6 text-gray-500 dark:text-gray-400"></i>
            </div>
        </div>
    </header>

    <div class="flex h-screen pt-16">
        <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg h-full p-4 space-y-4 border-r border-gray-200 dark:border-gray-700 fixed top-16 z-20">
            <nav class="space-y-2">
                <a class='flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 transition hover:bg-blue-50 dark:hover:bg-gray-700' href='/dashboard'>
                    <i data-feather="home" class="w-5 h-5"></i><span>Dashboard</span>
                </a>
                <a class='flex items-center space-x-3 px-4 py-3 rounded-xl bg-blue-50 dark:bg-gray-700 text-blue-700 dark:text-blue-300 font-semibold transition hover:bg-blue-100 dark:hover:bg-gray-600' href='/chat'>
                    <i data-feather="message-circle" class="w-5 h-5"></i><span>Chat with Luna</span>
                </a>
                 <a class='flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 transition hover:bg-blue-50 dark:hover:bg-gray-700' href='/notes'>
                    <i data-feather="file-text" class="w-5 h-5"></i><span>Notes & Summaries</span>
                </a>
                <a class='flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 transition hover:bg-blue-50 dark:hover:bg-gray-700' href='/quizzes'>
                    <i data-feather="book-open" class="w-5 h-5"></i><span>Quizzes</span>
                </a>
                <a class='flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 transition hover:bg-blue-50 dark:hover:bg-gray-700' href='/focus'>
                    <i data-feather="clock" class="w-5 h-5"></i><span>Focus Mode</span>
                </a>
            </nav>
        </aside>

        <main id="mainContent" class="flex-1 flex flex-col p-8 md:ml-64 transition-all duration-300">
            <div id="proContainer" class="h-full flex flex-col">
                </div>
        </main>
        
        <aside id="historySidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg h-full p-4 border-l border-gray-200 dark:border-gray-700 fixed top-16 right-0 z-20 flex flex-col">
            <div class="flex-shrink-0 mb-4">
                <button id="newChatBtn" class="w-full flex items-center justify-center space-x-2 px-4 py-3 rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition">
                    <i data-feather="plus" class="w-5 h-5"></i>
                    <span>New Chat</span>
                </button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto space-y-2">
                </div>
        </aside>

    </div>

    <div id="unlockProModal" class="unlock-modal">
        </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAeq9Tuo5CmLRh35thABNj-Qv9V_hpjB9c",
            authDomain: "study-a25ac.firebaseapp.com",
            projectId: "study-a25ac",
            storageBucket: "study-a25ac.appspot.com",
            messagingSenderId: "173051640117",
            appId: "1:173051640117:web:2ee34824b54b2e9ba7b47c",
            measurementId: "G-MCSV02V3Q3"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        const mainContent = document.getElementById('mainContent');
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const historySidebar = document.getElementById('historySidebar');
        const toggleHistoryBtn = document.getElementById('toggleHistory');
        const historyList = document.getElementById('historyList');
        const newChatBtn = document.getElementById('newChatBtn');
        const proContainer = document.getElementById('proContainer');
        const darkModeToggle = document.getElementById('toggleDarkMode');
        const htmlElement = document.documentElement;

        let allChats = {};
        let activeChatId = null;
        let isRecording = false;
        let recognition = null;
        let typingIndicatorElement = null;
        const aiAvatarUrl = 'CA.png';
        const initialGreeting = { role: "model", parts: [{ text: "Hello! How can I assist you with your studies today?" }] };

        // Quick reply suggestions
        const quickReplies = [
            "Summarize notes",
            "Quiz me",
            "Explain concept",
            "Study tips",
            "Practice problems"
        ];

        function saveState() {
            localStorage.setItem('allChats', JSON.stringify(allChats));
            localStorage.setItem('activeChatId', activeChatId);
        }

        function loadState() {
            const savedChats = JSON.parse(localStorage.getItem('allChats'));
            const savedActiveId = localStorage.getItem('activeChatId');
            
            if (savedChats && Object.keys(savedChats).length > 0) {
                allChats = savedChats;
                activeChatId = savedActiveId in allChats ? savedActiveId : Object.keys(allChats)[0];
            } else {
                startNewChat(false);
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showTypingIndicator() {
            const chatWindow = document.getElementById('chatWindow');
            if (!chatWindow || typingIndicatorElement) return;

            typingIndicatorElement = document.createElement('div');
            typingIndicatorElement.className = 'flex items-start space-x-3 typing-indicator';
            typingIndicatorElement.innerHTML = `
                <div class="w-8 h-8 rounded-full border-2 border-gray-300 dark:border-gray-600 overflow-hidden flex-shrink-0">
                    <img src="${aiAvatarUrl}" alt="AI Avatar" class="w-full h-full object-cover">
                </div>
                <div class="bg-gray-200 dark:bg-gray-700 rounded-2xl p-3 max-w-[75%] shadow flex items-center">
                    <span class="text-gray-500 dark:text-gray-400 mr-2">Luna is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>`;
            chatWindow.appendChild(typingIndicatorElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function hideTypingIndicator() {
            if (typingIndicatorElement) {
                typingIndicatorElement.remove();
                typingIndicatorElement = null;
            }
        }

        function createResponseActions() {
            return `
                <div class="flex items-center space-x-1 mt-2">
                    <button class="action-btn copy-btn px-2 py-1 text-xs bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-500 transition-all duration-200">
                        <i data-feather="copy" class="w-3 h-3"></i> Copy
                    </button>
                    <button class="action-btn save-note-btn px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-all duration-200">
                        <i data-feather="bookmark" class="w-3 h-3"></i> Save as Note
                    </button>
                    <button class="action-btn quiz-btn px-2 py-1 text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 rounded hover:bg-green-200 dark:hover:bg-green-800 transition-all duration-200">
                        <i data-feather="help-circle" class="w-3 h-3"></i> Convert to Quiz
                    </button>
                </div>`;
        }

        function setupVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isRecording = true;
                    const voiceBtn = document.getElementById('voiceBtn');
                    if (voiceBtn) {
                        voiceBtn.classList.add('recording');
                    }
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const userInput = document.getElementById('userInput');
                    if (userInput) {
                        userInput.value = transcript;
                        userInput.focus();
                    }
                };

                recognition.onend = function() {
                    isRecording = false;
                    const voiceBtn = document.getElementById('voiceBtn');
                    if (voiceBtn) {
                        voiceBtn.classList.remove('recording');
                    }
                };

                recognition.onerror = function(event) {
                    isRecording = false;
                    const voiceBtn = document.getElementById('voiceBtn');
                    if (voiceBtn) {
                        voiceBtn.classList.remove('recording');
                    }
                    showToast('Voice recognition error. Please try again.', 'error');
                };
            }
        }

        function handleVoiceInput() {
            if (!recognition) {
                showToast('Voice recognition not supported in this browser.', 'error');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function renderQuickReplies() {
            return `
                <div class="flex flex-wrap gap-2 mb-3">
                    ${quickReplies.map(reply => `
                        <button class="quick-reply-btn px-3 py-1 text-sm bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200" 
                                data-reply="${reply}">
                            ${reply}
                        </button>
                    `).join('')}
                </div>`;
        }

        function renderHistorySidebar() {
            historyList.innerHTML = '';
            const sortedChatIds = Object.keys(allChats).sort((a, b) => b - a);

            sortedChatIds.forEach(chatId => {
                const chat = allChats[chatId];
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-3 rounded-lg cursor-pointer group transition ${chatId === activeChatId ? 'bg-blue-100 dark:bg-gray-700' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                item.dataset.chatId = chatId;
                
                const title = chat.title.length > 25 ? chat.title.substring(0, 25) + '...' : chat.title;
                item.innerHTML = `
                    <span class="text-sm text-gray-700 dark:text-gray-300 flex-1 pr-2">${title}</span>
                    <button class="delete-chat-btn opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700" data-chat-id="${chatId}">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                historyList.appendChild(item);
            });
            feather.replace();
        }

        function loadChat(chatId) {
            activeChatId = chatId;
            const chat = allChats[chatId];
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.innerHTML = '';
            
            chat.messages.forEach(msg => {
                appendMessage(msg.parts[0].text, msg.role === 'user' ? 'user' : 'ai', false);
            });
            renderHistorySidebar();
            saveState();
        }

        function startNewChat(saveCurrent = true) {
            if (saveCurrent && activeChatId && allChats[activeChatId].messages.length <= 1) {
                delete allChats[activeChatId];
            }

            const newId = Date.now().toString();
            activeChatId = newId;
            allChats[newId] = {
                title: 'New Chat',
                messages: [initialGreeting]
            };
            loadChat(newId);
        }
        
        async function deleteChat(chatId) {
            if (!confirm('Are you sure you want to delete this chat?')) return;

            delete allChats[chatId];
            
            if (activeChatId === chatId) {
                const remainingIds = Object.keys(allChats);
                if (remainingIds.length > 0) {
                    loadChat(remainingIds.sort((a,b) => b - a)[0]);
                } else {
                    startNewChat(false);
                }
            }
            renderHistorySidebar();
            saveState();
        }

        async function generateTitleForChat(chatId, firstMessage) {
            if (allChats[chatId].title !== 'New Chat') return;

            const apiKey = "AIzaSyA19xjTISq7xJRx8ab3-TGaSlVW7XxWFwQ";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{ text: `Generate a very short, concise title (max 4 words) for a conversation that starts with this user message: "${firstMessage}". Just return the title, nothing else.` }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                const title = result.candidates[0].content.parts[0].text.trim().replace(/"/g, '');
                allChats[chatId].title = title;
                renderHistorySidebar();
                saveState();
            } catch (error) {
                console.error("Error generating title:", error);
            }
        }
        
        function appendMessage(message, sender, shouldScroll = true) {
            const chatWindow = document.getElementById('chatWindow');
            if (!chatWindow) return;

            const messageDiv = document.createElement('div');
            const messageContent = document.createElement('div');

            if (sender === 'user') {
                messageDiv.className = 'flex items-start justify-end';
                messageContent.className = 'message-bubble user-bubble bg-blue-600 text-white rounded-2xl p-3 max-w-[75%] shadow';
                messageContent.textContent = message;
            } else { 
                messageDiv.className = 'flex items-start space-x-3';
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'w-8 h-8 rounded-full border-2 border-gray-300 dark:border-gray-600 overflow-hidden flex-shrink-0';
                avatarDiv.innerHTML = `<img src="${aiAvatarUrl}" alt="AI Avatar" class="w-full h-full object-cover">`;

                messageContent.className = 'message-bubble bg-gray-200 dark:bg-gray-700 rounded-2xl p-3 max-w-[75%] shadow';
                messageContent.innerHTML = marked.parse(message) + createResponseActions();
                
                messageDiv.appendChild(avatarDiv);
            }
            
            messageDiv.appendChild(messageContent);
            chatWindow.appendChild(messageDiv);
            
            // Add event listeners for response actions
            if (sender === 'ai') {
                const copyBtn = messageContent.querySelector('.copy-btn');
                const saveNoteBtn = messageContent.querySelector('.save-note-btn');
                const quizBtn = messageContent.querySelector('.quiz-btn');

                copyBtn?.addEventListener('click', () => {
                    navigator.clipboard.writeText(message).then(() => {
                        showToast('Response copied to clipboard!');
                    });
                });

                saveNoteBtn?.addEventListener('click', () => {
                    // Here you would integrate with your notes system
                    showToast('Response saved as note!');
                });

                quizBtn?.addEventListener('click', () => {
                    // Here you would integrate with your quiz system
                    showToast('Converting to quiz...');
                });
            }
            
            feather.replace();
            if(shouldScroll) chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function setupChatListeners() {
            const chatForm = document.getElementById('chatForm');
            const userInput = document.getElementById('userInput');
            const chatWindow = document.getElementById('chatWindow');
            const voiceBtn = document.getElementById('voiceBtn');

            // Quick reply buttons
            document.addEventListener('click', (e) => {
                if (e.target.closest('.quick-reply-btn')) {
                    const reply = e.target.closest('.quick-reply-btn').dataset.reply;
                    userInput.value = reply;
                    userInput.focus();
                }
            });

            // Voice input button
            voiceBtn?.addEventListener('click', handleVoiceInput);

            if (chatForm) {
                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userMessage = userInput.value.trim();
                    if (!userMessage) return;

                    if (allChats[activeChatId].messages.length === 1) {
                       generateTitleForChat(activeChatId, userMessage);
                    }

                    appendMessage(userMessage, 'user');
                    allChats[activeChatId].messages.push({ role: "user", parts: [{ text: userMessage }] });
                    saveState();
                    userInput.value = '';

                    // Show typing indicator instead of loading spinner
                    showTypingIndicator();

                    const apiKey = "AIzaSyA19xjTISq7xJRx8ab3-TGaSlVW7XxWFwQ";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: allChats[activeChatId].messages })
                        });
                        
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        
                        const result = await response.json();
                        const aiResponseText = result.candidates[0].content.parts[0].text;
                        
                        hideTypingIndicator();
                        appendMessage(aiResponseText, 'ai');
                        allChats[activeChatId].messages.push({ role: "model", parts: [{ text: aiResponseText }] });
                        saveState();

                    } catch (error) {
                        console.error("Chat API Error:", error);
                        hideTypingIndicator();
                        appendMessage(`Sorry, an error occurred: ${error.message}. Please try again.`, 'ai');
                    }
                });
            }
        }
        
        function checkProStatus() {
            const isPro = true;
            
            if (isPro) {
                proContainer.innerHTML = `
                    <header id="chatHeader" class="flex items-center justify-between border-b border-gray-300 dark:border-gray-700 pb-3 mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600 overflow-hidden">
                                <img src="${aiAvatarUrl}" alt="AI Avatar" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h2 class="font-semibold text-lg">AI Study Assistant</h2>
                                <p class="text-sm text-green-500">Online</p>
                            </div>
                        </div>
                    </header>
                    <section id="chatWindow" class="chat-window flex-1 overflow-y-auto min-h-0 p-4 space-y-4 bg-white rounded-3xl shadow dark:bg-gray-800"></section>
                    <div class="mt-4">
                        ${renderQuickReplies()}
                        <form id="chatForm" class="flex space-x-3">
                            <input type="text" id="userInput" placeholder="Type your message..." class="flex-1 rounded-full px-4 py-3 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-200 transition" autocomplete="off" required />
                            <button type="button" id="voiceBtn" class="voice-btn bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 rounded-full p-3 transition-all duration-200" title="Voice input">
                                <i data-feather="mic" class="w-5 h-5"></i>
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-6 py-3 font-semibold transition transform hover:scale-105">Send</button>
                        </form>
                    </div>`;
                
                loadState();
                renderHistorySidebar();
                loadChat(activeChatId);
                setupChatListeners();
                setupVoiceRecognition();
            } else {
                historySidebar.style.display = 'none';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    checkProStatus();
                } else {
                    window.location.href = 'index.html';
                }
            });

            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hide');
                mainContent.classList.toggle('md:ml-64');
            });

            toggleHistoryBtn.addEventListener('click', () => {
                historySidebar.classList.toggle('show');
                document.body.classList.toggle('history-open');
            });
            
            newChatBtn.addEventListener('click', () => startNewChat());

            historyList.addEventListener('click', (e) => {
                const chatItem = e.target.closest('[data-chat-id]');
                const deleteBtn = e.target.closest('.delete-chat-btn');

                if (deleteBtn) {
                    e.stopPropagation(); 
                    deleteChat(deleteBtn.dataset.chatId);
                } else if (chatItem) {
                    loadChat(chatItem.dataset.chatId);
                }
            });

            const loadTheme = () => {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    htmlElement.classList.add('dark');
                } else {
                    htmlElement.classList.remove('dark');
                }
                updateDarkModeIcon();
            };

            const updateDarkModeIcon = () => {
                darkModeToggle.innerHTML = htmlElement.classList.contains('dark') ? '<i data-feather="sun"></i>' : '<i data-feather="moon"></i>';
                feather.replace();
            };

            darkModeToggle.addEventListener('click', () => {
                htmlElement.classList.toggle('dark');
                localStorage.theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                updateDarkModeIcon();
            });

            loadTheme();
            feather.replace();
        });
    </script>
</body>

</html>
